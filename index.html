<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aude Analytics - GeoLab 2026</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Playfair+Display:ital,wght@0,700;1,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.bundled.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    
<style>
    /* --- 1. VARIABLES & RESET --- */
    :root {
        --bg-main: #F8FAFC;          
        --color-vivid: #F97316;      
        --color-dark: #0F172A;       
        --text-body: #334155;        
        --glass-border: rgba(255, 255, 255, 0.6);
        --shadow-soft: 0 10px 40px -10px rgba(0,0,0,0.08);
        
        /* Couleurs Carte */
        --c-artif: #EF4444; --c-agri: #EAB308; --c-nature: #84CC16; --c-water: #3B82F6; --c-foret: #835217;
        
        --ease-premium: cubic-bezier(0.23, 1, 0.32, 1);
    }

    * { box-sizing: border-box; }
    
    body, html { 
        margin: 0; padding: 0; width: 100%; height: 100%; 
        font-family: 'DM Sans', sans-serif; background-color: var(--bg-main); 
        color: var(--text-body); overflow-x: hidden; scroll-behavior: smooth;
    }

    /* Bruit de fond (Grain) */
    body::before {
        content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
        pointer-events: none; z-index: 9999; mix-blend-mode: multiply;
    }

    /* --- CREDITS FIXES --- */
    .credits-fixed {
        position: fixed; bottom: 30px; left: 120px; z-index: 2000;
        display: flex; align-items: center; gap: 15px; 
        opacity: 0.8; transition: 0.3s;
        pointer-events: none;
    }
    
    .credits-fixed:hover { opacity: 1; }
    .credits-separator { width: 2px; height: 35px; background: var(--color-vivid); border-radius: 2px; }
    .credits-content { display: flex; flex-direction: column; justify-content: center; }
    .credits-title { font-family: 'Playfair Display', serif; font-weight: 700; font-size: 1.1rem; color: var(--color-dark); line-height: 1; margin-bottom: 2px; }
    .credits-subtitle { font-family: 'DM Sans', sans-serif; font-size: 0.7rem; color: #64748B; font-weight: 500; }

    body.night .credits-title { color: #F8FAFC; }
    body.night .credits-subtitle { color: #94A3B8; }

    /* --- SIDEBAR & NAVIGATION --- */
    .sidebar {
        position: fixed; left: 0; top: 0; height: 100vh; width: 80px;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        z-index: 2000; pointer-events: none;
    }
    .scroll-indicators { pointer-events: auto; display: flex; flex-direction: column; gap: 20px; }
    .dot { 
        width: 8px; height: 8px; background: #CBD5E1; border-radius: 50%; 
        cursor: pointer; transition: all 0.4s var(--ease-premium); 
    }
    .dot.active { background: var(--color-vivid); transform: scale(1.5); box-shadow: 0 0 0 4px rgba(249, 115, 22, 0.15); }

    .burger {
        position: fixed; top: 30px; right: 30px; width: 44px; height: 44px;
        display: flex; justify-content: center; align-items: center;
        cursor: pointer; z-index: 3000; background: white; border-radius: 50%;
        box-shadow: var(--shadow-soft); transition: 0.3s; font-size: 1.2rem; color: var(--color-dark);
    }
    .burger:hover { transform: rotate(15deg); }

    /* --- LAYOUT & TYPO --- */
    .main-content { width: 100%; }
    .page-section { 
        min-height: 100vh; width: 100%; display: flex; 
        position: relative; padding-left: 80px;
    }

    h1 { 
        font-family: 'Playfair Display'; font-size: 5.5rem; font-weight: 800; margin: 0; line-height: 0.9;
        color: var(--color-vivid); 
        filter: drop-shadow(0 2px 10px rgba(0,0,0,0.1));
    }
    
    h2 { font-family: 'Playfair Display'; font-size: 3.5rem; font-weight: 700; color: var(--color-dark); margin: 10px 0 30px 0; line-height: 1.1; }
    .subtitle { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 3px; color: #94A3B8; font-weight: 700; display: block; margin-bottom: 10px; }
    .description-text { font-size: 1.1rem; line-height: 1.7; color: var(--text-body); max-width: 550px; }

    /* --- PAGE 1 --- */
    #page1 { height: auto; min-height: 160vh; align-items: flex-start; }
    .p1-content { width: 50%; padding: 15vh 6% 15vh 8%; display: flex; flex-direction: column; justify-content: center; }
    .p1-map-container { width: 50%; height: 100vh; background: #F8F9FA; position: sticky; top: 0; right: 0; }
    #map-home { height: 100%; width: 100%; opacity: 0.9; }
    .kpi-section { margin-top: 50px; display: flex; gap: 50px; padding-bottom: 40px; border-bottom: 1px solid #E2E8F0; margin-bottom: 40px; }
    .big-number { font-family: 'Playfair Display'; font-size: 3rem; font-weight: 700; color: var(--color-dark); line-height: 1; }
    .big-number span { display: block; font-family: 'DM Sans'; font-size: 0.7rem; color: #94A3B8; font-weight: 700; text-transform: uppercase; margin-top: 8px; letter-spacing: 1px; }
    .highlight { color: var(--color-vivid); font-weight: 700; }

    /* --- PAGE 2 (SPLIT) --- */
    .split-layout { display: flex; width: 100%; height: 100vh; }
    .text-panel { width: 40%; padding: 0 5%; display: flex; flex-direction: column; justify-content: center; background: var(--bg-main); overflow-y: auto; z-index: 2; }
    .viz-panel { width: 60%; position: relative; display: flex; }
    .map-split { width: 50%; height: 100%; position: relative; border-right: 2px solid white; }
    .map-badge-pill {
        position: absolute; top: 25px; left: 50%; transform: translateX(-50%);
        background: rgba(255,255,255,0.9); backdrop-filter: blur(8px);
        padding: 8px 20px; border-radius: 30px;
        font-family: 'DM Sans'; font-size: 0.75rem; font-weight: 800; color: var(--color-dark);
        box-shadow: 0 4px 20px rgba(0,0,0,0.1); z-index: 500;
        display: flex; flex-direction: column; align-items: center;
        border: 1px solid white;
    }

    .context-box { 
        background: white; border-radius: 12px; padding: 25px; margin: 30px 0;
        box-shadow: var(--shadow-soft); border: 1px solid #F1F5F9;
        position: relative; overflow: hidden;
    }
    .context-box::before { content:''; position:absolute; left:0; top:0; bottom:0; width:4px; background:var(--color-vivid); }
    .legend-box { display: flex; gap: 15px; flex-wrap: wrap; margin-top: 20px; }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.75rem; font-weight: 600; color: #64748B; background: white; padding: 5px 10px; border-radius: 20px; border: 1px solid #E2E8F0; }
    .color-dot { width: 8px; height: 8px; border-radius: 50%; }

    /* --- PAGE 3 --- */
    .map-overlay { position: absolute; top: 20px; left: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 12px; width: 220px; }
    .method-switch { background: white; padding: 4px; border-radius: 12px; display: flex; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    .method-btn { flex: 1; border: none; padding: 8px; border-radius: 8px; background: transparent; font-family: 'DM Sans'; font-weight: 600; font-size: 0.75rem; color: #64748B; cursor: pointer; transition: 0.3s; }
    .method-btn.active { background: var(--color-vivid); color: white; }
    .capsule-select-wrapper { position: relative; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
    .capsule-select { width: 100%; padding: 10px 15px; border: none; background: transparent; font-family: 'DM Sans'; font-size: 0.85rem; font-weight: 700; color: var(--color-dark); appearance: none; cursor: pointer; outline: none; }
    .filter-row { display: flex; flex-wrap: wrap; gap: 6px; }
    .filter-btn { border: 1px solid rgba(0,0,0,0.1); padding: 6px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; color: white; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    
    .deck-container { perspective: 1200px; padding: 20px 0; overflow: visible; height: 400px; display: flex; align-items: center; }
    .deck-card { min-width: 300px; width: 300px; height: 350px; background: white; border-radius: 20px; box-shadow: 0 20px 40px -10px rgba(0,0,0,0.1); border: 1px solid #F1F5F9; margin-right: -100px; position: relative; transition: 0.5s var(--ease-premium); cursor: pointer; display: flex; flex-direction: column; overflow: hidden; transform-style: preserve-3d; }
    .deck-card.active { width: 500px; min-width: 500px; margin-right: 40px; z-index: 50; transform: translateZ(20px) rotateY(-2deg); box-shadow: 0 40px 80px -20px rgba(0,0,0,0.15); border: 1px solid var(--color-vivid); }
    .chart-content { flex: 1; padding: 30px; opacity: 0; transition: 0.3s; display: flex; flex-direction: column; gap: 12px; background: white; }
    .deck-card.active .chart-content { opacity: 1; }

    /* --- PAGE 4 --- */
    #page4 { position: relative; z-index: 10; background: var(--bg-main); padding: 80px 10%; flex-direction: column; justify-content: center; height: auto; min-height: 100vh; box-shadow: 0 -20px 50px rgba(0,0,0,0.05); }
    .tm-container { width: 100%; height: 240px; display: flex; border-radius: 16px; overflow: hidden; background: #F1F5F9; position: relative; }
    .tm-item { border: 1px solid white; transition: 0.2s; }
    .cta-btn { background: var(--color-dark); color: #919191; padding: 16px 40px; border-radius: 50px; text-decoration: none; font-weight: 700; font-size: 1rem; display: inline-flex; align-items: center; gap: 10px; transition: 0.3s; box-shadow: 0 20px 40px -10px rgba(15, 23, 42, 0.3); }

    /* --- MODE NUIT --- */
    body.night { --bg-main: #0F172A; --text-body: #94A3B8; --color-dark: #F8FAFC; }
    body.night .map-badge-pill, body.night .context-box, body.night .legend-item, body.night .method-switch, body.night .capsule-select-wrapper, body.night .deck-card { background: #1E293B; border-color: #334155; color: #F1F5F9; }
    body.night .chart-content { background: #1E293B; }
    body.night #page4 { background: #0F172A; }
    
    #map-viz { height: 100%; width: 100%; background: #ebe7e0; }
</style>
</head>
<body>

    <aside class="sidebar">
        <div class="scroll-indicators">
            <div class="dot active" onclick="scrollToId('page1')" id="dot1"></div>
            <div class="dot" onclick="scrollToId('page2')" id="dot2"></div>
            <div class="dot" onclick="scrollToId('page3')" id="dot3"></div>
            <div class="dot" onclick="scrollToId('page4')" id="dot4"></div>
        </div>
    </aside>

    <div class="credits-fixed">
        <i class="fas fa-university" style="font-size:1.8rem; color:var(--text-body);"></i>
        <div class="credits-separator"></div>
        <div class="credits-content">
            <span class="credits-title">GeoLab 2026</span>
            <span class="credits-subtitle">Master OTG · Université de Strasbourg</span>
        </div>
    </div>

    <div class="burger" onclick="toggleNight()"><i class="fas fa-moon"></i></div>

    <div class="main-content">
        
        <section class="page-section" id="page1">
            <div class="p1-content">
                <span class="subtitle">Analyse Territoriale & Géomatique</span>
                <h1>Aude<br>Mise à jour.</h1>
                <hr class="separator">
                <p class="description-text">Une exploration cartographique nouvelle génération pour comprendre l'occupation des sols.</p>
                <div class="kpi-section">
                    <div class="big-number">6 342<span>km² Superficie</span></div>
                    <div class="big-number">433<span>Communes</span></div>
                    <div class="big-number">48%<span>Espaces Naturels</span></div>
                </div>
            </div>
            <div class="p1-map-container"><div id="map-home"></div></div>
        </section>

        <section class="page-section" id="page2" style="padding:0;"> 
            <div class="split-layout">
                <div class="text-panel" style="padding-left: 100px;">
                    <span class="subtitle">Diagnostic</span>
                    <h2>Résolution.</h2>
                    <div class="context-box"><p>Le Conflit Usage vs Couverture : OSO (Gauche) vs COSIA (Droite).</p></div>
                    <div class="legend-box">
                        <div class="legend-item"><div class="color-dot" style="background:var(--c-artif)"></div>Artif</div>
                        <div class="legend-item"><div class="color-dot" style="background:var(--c-agri)"></div>Agri</div>
                        <div class="legend-item"><div class="color-dot" style="background:var(--c-nature)"></div>Nature</div>
                    </div>
                </div>
                <div class="viz-panel">
                    <div id="map-left" class="map-split"><div class="map-badge-pill">OSO 2023</div></div>
                    <div id="map-right" class="map-split"><div class="map-badge-pill">COSIA 2024</div></div>
                </div>
            </div>
        </section>

        <section class="page-section" id="page3" style="padding:0;">
            <div class="split-layout">
                <div class="viz-panel">
                    <div class="map-overlay">
                        <div class="method-switch">
                            <button class="method-btn active" id="btn-m1" onclick="switchMethod('m1')">Méthode 1</button>
                            <button class="method-btn" id="btn-m2" onclick="switchMethod('m2')">Méthode 2</button>
                        </div>
                        <div class="capsule-select-wrapper">
                            <select id="dalleSelector" class="capsule-select" onchange="updatePage3(this.value)"></select>
                        </div>
                        <div class="filter-row">
                            <button class="filter-btn" style="background:var(--c-water)" onclick="toggleFilter('Eau', this)">Eau</button>
                            <button class="filter-btn" style="background:var(--c-artif)" onclick="toggleFilter('Artif', this)">Artif</button>
                        </div>
                    </div>
                    <div id="map-viz"></div>
                </div>
                <div class="text-panel">
                    <div style="padding: 40px;">
                        <h2 id="dashTitle">Analyse.</h2>
                        <div class="deck-container">
                            <div class="deck-card active" onclick="activateDeck(this)">
                                <div class="deck-header"><div class="deck-title">Indice de Confiance</div></div>
                                <div class="chart-content" id="chart-confiance"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="page-section" id="page4" style="flex-direction: column; padding: 80px 10%; height: auto;">
            <div style="display:flex; justify-content:flex-end; margin-bottom:20px;">
                <select id="p4-dalleSelector" class="capsule-select" onchange="updatePage4(this.value)" style="width:200px; border:1px solid #ddd;"></select>
            </div>
            <div class="treemap-section">
                <h3>Répartition des Surfaces</h3>
                <div class="tm-container" id="treemap-container"></div>
                <div id="treemap-legend" style="display:flex; gap:20px; margin-top:20px;"></div>
            </div>
            <div style="text-align:center; margin-top:60px;">
                <a href="#" class="cta-btn">Accéder à la Carte <i class="fas fa-database"></i></a>
            </div>
        </section>
    </div>

    <script>
        // --- LOGIQUE GZIP & CHARGEMENT ---
        async function fetchGeoJSON(url) {
            const response = await fetch(url);
            if (!response.ok) throw new Error("Erreur chargement : " + url);
            if (url.endsWith('.gz')) {
                const buffer = await response.arrayBuffer();
                const decompressed = pako.ungzip(new Uint8Array(buffer), { to: 'string' });
                return JSON.parse(decompressed);
            }
            return await response.json();
        }

        const URL_LIGHT = 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
        const URL_DARK  = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';

        // --- MAPS SETUP ---
        var mapHome = L.map('map-home', {zoomControl:false, attributionControl:false});
        L.tileLayer(URL_LIGHT).addTo(mapHome);

        var mapLeft = L.map('map-left', {zoomControl:false, attributionControl:false}).setView([43.255, 2.368], 16);
        var mapRight = L.map('map-right', {zoomControl:false, attributionControl:false}).setView([43.255, 2.368], 16);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(mapLeft);
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(mapRight);
        mapLeft.on('move', () => mapRight.setView(mapLeft.getCenter(), mapLeft.getZoom(), {animate:false}));
        mapRight.on('move', () => mapLeft.setView(mapRight.getCenter(), mapRight.getZoom(), {animate:false}));

        // --- CHARGEMENT DES DONNÉES ---
        var geoDataM1, geoDataM2, globalGeoData, vizLayer, currentMethod = 'm1';
        var activeFilters = { 'Eau': true, 'Artif': true, 'Nature': true, 'Agri': true, 'Forêt': true };

        async function init() {
            try {
                // Page 1
                const aude = await fetchGeoJSON('https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/departements/11-aude/departement-11-aude.geojson');
                L.geoJSON(aude, {style:{color:'#F97316', weight:2, fillOpacity:0.05}}).addTo(mapHome);
                mapHome.fitBounds(L.geoJSON(aude).getBounds());

                // Page 2
                const oso = await fetchGeoJSON('donne/OSO_2023_DALLE_2.geojson');
                L.geoJSON(oso, {style: f => ({color:'#EF4444', weight:1, fillOpacity:0.5})}).addTo(mapLeft);
                
                // LE GZIP ICI
                const cosia = await fetchGeoJSON('donne/COSIA_2024_DALLE_2.geojson.gz');
                L.geoJSON(cosia, {style: f => ({color:'#84CC16', weight:1, fillOpacity:0.5})}).addTo(mapRight);

                // Page 3 & 4
                geoDataM1 = await fetchGeoJSON('donne/GLOBAL_DALLES.geojson');
                geoDataM2 = await fetchGeoJSON('donne/METHODE_2.geojson');
                globalGeoData = geoDataM1;

                populateSelectors();
                updatePage3(document.getElementById('dalleSelector').value);
                updatePage4('all');
            } catch(e) { console.error(e); }
        }

        // --- FONCTIONS DASHBOARD ---
        function updatePage3(id) {
            if(!globalGeoData) return;
            const filtered = globalGeoData.features.filter(f => String(f.properties.DALLE) === String(id));
            if(vizLayer) mapViz.removeLayer(vizLayer);
            vizLayer = L.geoJSON({type:"FeatureCollection", features:filtered}, {
                style: f => ({fillColor:'#F97316', weight:0.5, fillOpacity:0.8})
            }).addTo(mapViz);
            if(filtered.length) mapViz.fitBounds(vizLayer.getBounds());
            document.getElementById('dashTitle').innerText = "Dalle " + id;
        }

        function updatePage4(id) {
            if(!geoDataM1) return;
            let data = id === 'all' ? geoDataM1.features : geoDataM1.features.filter(f => String(f.properties.DALLE) === String(id));
            let stats = { 'Artif':0, 'Agri':0, 'Nature':0 };
            data.forEach(f => { stats['Artif']++; }); // Logique simplifiée pour l'exemple
            drawTreemap(stats);
        }

        function drawTreemap(stats) {
            const cont = document.getElementById('treemap-container');
            cont.innerHTML = `<div style="width:100%; height:100%; background:var(--c-agri); opacity:0.7; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold;">Visualisation des Surfaces</div>`;
        }

        function populateSelectors() {
            const dalles = [...new Set(geoDataM1.features.map(f => f.properties.DALLE))].sort();
            const s3 = document.getElementById('dalleSelector');
            const s4 = document.getElementById('p4-dalleSelector');
            s4.innerHTML = '<option value="all">Vue Départementale</option>';
            dalles.forEach(d => { s3.innerHTML += `<option value="${d}">Dalle ${d}</option>`; s4.innerHTML += `<option value="${d}">Dalle ${d}</option>`; });
        }

        function switchMethod(m) {
            currentMethod = m;
            globalGeoData = (m === 'm1') ? geoDataM1 : geoDataM2;
            updatePage3(document.getElementById('dalleSelector').value);
        }

        function toggleNight() { document.body.classList.toggle('night'); updateLeafletTheme(); }
        function updateLeafletTheme() { /* Changement de fond de carte */ }
        function scrollToId(id) { document.getElementById(id).scrollIntoView({ behavior: 'smooth' }); }
        function activateDeck(el) { document.querySelectorAll('.deck-card').forEach(c=>c.classList.remove('active')); el.classList.add('active'); }

        var mapViz = L.map('map-viz', {zoomControl:false}).setView([43.212, 2.355], 13);
        L.tileLayer(URL_LIGHT).addTo(mapViz);

        init();
    </script>
</body>
</html>